# Lighthouse pipeline
variables:
  CI: true

jobs:
- job: Windows
  pool:
    vmImage: 'windows-2019'
  variables:
    YARN_CACHE_FOLDER: $(Pipeline.Workspace)/.yarn
  steps:
    - powershell: |
        Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
        scoop bucket add extras
        scoop install googlechrome-canary
        Write-Host "##vso[task.setvariable variable=CHROME_PATH;]$env:USERPROFILE\scoop\apps\googlechrome-canary\current\chrome.exe"
      displayName: "Install chrome canary"
    - task: NodeTool@0
      inputs:
        versionSpec: "10.x"
      displayName: "Install Node.js"
    - task: CacheBeta@1
      inputs:
        key: yarn | $(Agent.OS) | yarn.lock
        path: $(YARN_CACHE_FOLDER)
        restoreKeys: |
          yarn | $(Agent.OS)
          yarn
      displayName: Cache Yarn packages
    - script: yarn --frozen-lockfile
      displayName: "Install dependencies"
    - script: yarn build-all
    # - script: yarn unit-core --runInBand
    #   # Appveyor protocol timeouts are unusually common.
    #   # We retry our smoketests 3 times for this reason, so do the same for CLI tests that launch Chrome.
    # - script: yarn unit-cli || yarn unit-cli || yarn unit-cli
    # - script: yarn unit-viewer
    - script: yarn smoke -j=1 --retries=2 a11y errors oopif pwa pwa2 pwa3 dbw redirects seo offline byte perf lantern metrics
